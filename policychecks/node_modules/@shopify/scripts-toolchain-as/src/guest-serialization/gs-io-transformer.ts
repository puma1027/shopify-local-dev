import {writeFileSync, mkdirSync, existsSync} from 'fs';
import * as path from 'path';
import {Transform} from 'assemblyscript/cli/transform';
import {Module, Program} from 'assemblyscript';
import {GSIOBuilder} from './gs-io-builder';

export = class GSIOTransformer extends Transform {
  program!: Program;

  afterInitialize(program: Program) {
    this.program = program;
  }

  afterCompile(_module: Module) {
    const projectPath = process.cwd();
    this.createTempFolder(projectPath);
    writeFileSync('tmp/io-wrapper.ts', GSIOBuilder.build(this.program));
  }

  createTempFolder(projectPath: string) {
    const tmp_dir = path.join(projectPath, 'tmp');
    if (!existsSync(tmp_dir)) {
      mkdirSync(tmp_dir);
    }
  }
};
