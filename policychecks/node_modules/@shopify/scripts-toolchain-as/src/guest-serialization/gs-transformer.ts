import {writeFileSync, mkdirSync, existsSync} from 'fs';
import * as path from 'path';
import {Transform} from 'assemblyscript/cli/transform';
import {Module, Program} from 'assemblyscript';
import {GSBuilder} from './gs-builder';

export = class GSTransformer extends Transform {
  program!: Program;

  afterInitialize(program: Program) {
    this.program = program;
  }

  afterCompile(_module: Module) {
    const projectPath = process.cwd();
    this.createTempFolder(projectPath);
    writeFileSync('tmp/serializer.ts', GSBuilder.build(this.program));
  }

  createTempFolder(projectPath: string) {
    const tmpDir = path.join(projectPath, 'tmp');
    if (!existsSync(tmpDir)) {
      mkdirSync(tmpDir);
    }
  }
};
